<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CP | Shrimp Bidding Helper (Excel/CSV Import, No Decimals)</title>
  <!-- SheetJS (อ่านไฟล์ Excel ฝั่งเบราว์เซอร์) -->
  https://cdn.jsdelivr.net/npm/xlsx@0.21.0/dist/xlsx.full.min.js</script>
  <style>
    :root{ --bg:#f7fafc; --panel:#ffffff; --text:#0f172a; --line:#e5e7eb; --primary:#0ea5e9; --good:#16a34a; --bad:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,TH Sarabun New,Prompt,sans-serif;background:var(--bg);color:var(--text)}
    .app{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;padding:4px 0 12px 0;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo-badge{width:40px;height:40px;border-radius:10px;background:#ffd54d;color:#b45309;display:grid;place-items:center;font-weight:800;border:1px solid #f59e0b}
    .shrimp{width:40px;height:40px}
    h1{font-size:18px;margin:0}
    .toolbar{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#ffffff;cursor:pointer}
    button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
    .tbl-wrap{display:none}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:right}
    th{background:#f3f4f6;color:#374151;position:sticky;top:0}
    td:first-child, th:first-child{text-align:left}
    td input[type=number]{width:140px;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text)}
    .cards{display:grid;grid-template-columns:1fr;gap:10px}
    .item{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
    .item-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .size{font-weight:600}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;color:#374151}
    .val{font-size:16px}
    .profit{font-weight:600}
    input[type=number]{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#0f172a;font-size:16px}
    @media (min-width: 900px){ .tbl-wrap{display:block} .cards{display:none} }
    .importer{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo-badge" title="CP">CP</div>
        <svg class="shrimp" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M10 34c0-12 10-22 22-22h16a8 8 0 110 16H32a6 6 0 100 12h10" fill="#fda4af" stroke="#db2777" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="42" cy="18" r="2" fill="#0f172a"/>
          <path d="M22 42c6 6 14 8 22 6" stroke="#db2777" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
      </div>
      <h1>ตัวช่วยคำนวณกำไร/กก. (Bidding)</h1>
      <div class="toolbar importer">
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        <button id="parseFile" class="primary">นำเข้า Excel/CSV</button>
        <button id="resetAll">ล้างค่า</button>
        <button id="exportCSV">ส่งออก CSV</button>
        <button id="sortCards">เรียงการ์ดตามกำไร</button>
      </div>
    </header>

    <!-- Desktop table view -->
    <div class="card tbl-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Size</th>
            <th>ราคาทุน</th>
            <th>ราคา W2</th>
            <th>กำไร/กก. (W2)</th>
            <th>ราคา Bidding</th>
            <th>กำไร/กก. (Bidding)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Mobile card list view -->
    <div class="cards" id="cards"></div>
  </div>

<script>
/** ====== DEFAULT (ว่าง) — จะถูกแทนที่เมื่อ import ====== */
const DATA = {config:{sizes: []}};

/** ====== STORAGE KEYS ====== */
const KEY_COSTS='shrimp_costs_v1';
const KEY_BIDS='shrimp_bids_v1';

/** ====== STATE ====== */
let costs = JSON.parse(localStorage.getItem(KEY_COSTS) || '{}');
let bids  = JSON.parse(localStorage.getItem(KEY_BIDS) || '{}');

/** ====== UTIL (จำนวนเต็ม) ====== */
const fmt0 = n => (n===null||n===undefined||isNaN(n))?'-':String(Math.round(Number(n)));   // ไม่มีคอมมา/ทศนิยม
const toNum0 = v => { const x = parseFloat(v); return isFinite(x)? Math.round(x) : NaN; };
const bySize = () => new Map(DATA.config.sizes.map(s=>[s.size,s]));
const normalizeHeader = h => (h||'').replace(/\r?\n/g,' ').trim();

/** ====== CORE CALC ====== */
function calc(cfg){
  const size = cfg.size;
  const cost = (costs[size] ?? cfg.last_cost ?? NaN);
  const floor = (isFinite(cost)?cost:NaN) + cfg.sga_lg;
  const w2 = floor + cfg.margin_w2;
  const pW2 = w2 - floor;         // = margin_w2
  const bid = (bids[size] ?? (cfg.last_bid ?? NaN));
  const pBid = isFinite(bid)? (bid - floor) : NaN;
  return {size,cost,w2,pW2,bid,pBid};
}

/** ====== DESKTOP TABLE ====== */
function buildTable(){
  const tbody = document.querySelector('#tbl tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  DATA.config.sizes.forEach(cfg=>{
    const r = calc(cfg);
    const tr = document.createElement('tr');

    const c0 = document.createElement('td'); c0.textContent = r.size; tr.appendChild(c0);
    const c1 = document.createElement('td'); c1.innerHTML = `<input type="number" step="1" inputmode="numeric" value="${isFinite(r.cost)?Math.round(r.cost):''}">`; tr.appendChild(c1);
    const c2 = document.createElement('td'); c2.textContent = fmt0(r.w2); tr.appendChild(c2);
    const c3 = document.createElement('td'); c3.textContent = fmt0(r.pW2); tr.appendChild(c3);
    const c4 = document.createElement('td'); c4.innerHTML = `<input type="number" step="1" inputmode="numeric" value="${isFinite(r.bid)?Math.round(r.bid):''}">`; tr.appendChild(c4);
    const c5 = document.createElement('td'); c5.textContent = fmt0(r.pBid); c5.style.color = isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : 'inherit'; tr.appendChild(c5);

    const costInput = c1.querySelector('input');
    const bidInput  = c4.querySelector('input');

    costInput.addEventListener('input',()=>{
      if(costInput.value===''){ delete costs[r.size]; } else { costs[r.size]=toNum0(costInput.value); }
      localStorage.setItem(KEY_COSTS, JSON.stringify(costs));
      const rr = calc(cfg);
      c2.textContent = fmt0(rr.w2);
      c3.textContent = fmt0(rr.pW2);
      c5.textContent = fmt0(rr.pBid);
      c5.style.color = isFinite(rr.pBid)? (rr.pBid>=0?'var(--good)':'var(--bad)') : 'inherit';
      updateCard(rr);
    });

    bidInput.addEventListener('input',()=>{
      if(bidInput.value===''){ delete bids[r.size]; } else { bids[r.size]=toNum0(bidInput.value); }
      localStorage.setItem(KEY_BIDS, JSON.stringify(bids));
      const rr = calc(cfg);
      c5.textContent = fmt0(rr.pBid);
      c5.style.color = isFinite(rr.pBid)? (rr.pBid>=0?'var(--good)':'var(--bad)') : 'inherit';
      updateCard(rr);
    });

    tbody.appendChild(tr);
  });
}

/** ====== MOBILE CARDS ====== */
function buildCards(){
  const wrap = document.getElementById('cards');
  if(!wrap) return;
  wrap.innerHTML='';
  const map = bySize();
  DATA.config.sizes.forEach(cfg=>{
    const r = calc(cfg);
    const card = document.createElement('div'); card.className='item'; card.id='card_'+r.size.replace(/\s+/g,'_');

    const head = document.createElement('div'); head.className='item-head';
    const sizeEl = document.createElement('div'); sizeEl.className='size'; sizeEl.textContent=r.size; head.appendChild(sizeEl);
    const profitEl = document.createElement('div'); profitEl.className='profit'; profitEl.textContent = fmt0(r.pBid); profitEl.style.color = isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : '#4b5563'; head.appendChild(profitEl);
    card.appendChild(head);

    const fields = document.createElement('div'); fields.className='fields';

    const fCost = document.createElement('div'); fCost.className='field';
    fCost.innerHTML = `<div class='label'>ราคาทุน</div><input type='number' step='1' inputmode='numeric' value='${isFinite(r.cost)?Math.round(r.cost):''}'>`;
    fields.appendChild(fCost);

    const fW2 = document.createElement('div'); fW2.className='field';
    fW2.innerHTML = `<div class='label'>ราคา W2</div><div class='val' id='W2_${r.size}'>${fmt0(r.w2)}</div>`;
    fields.appendChild(fW2);

    const fPW2 = document.createElement('div'); fPW2.className='field';
    fPW2.innerHTML = `<div class='label'>กำไร/กก. (W2)</div><div class='val' id='PW2_${r.size}'>${fmt0(r.pW2)}</div>`;
    fields.appendChild(fPW2);

    const fBid = document.createElement('div'); fBid.className='field';
    fBid.innerHTML = `<div class='label'>ราคา Bidding</div><input type='number' step='1' inputmode='numeric' value='${isFinite(r.bid)?Math.round(r.bid):''}'>`;
    fields.appendChild(fBid);

    const fPBid = document.createElement('div'); fPBid.className='field';
    fPBid.innerHTML = `<div class='label'>กำไร/กก. (Bidding)</div><div class='val' id='PBID_${r.size}'>${fmt0(r.pBid)}</div>`;
    fields.appendChild(fPBid);

    card.appendChild(fields);

    const cInput = fCost.querySelector('input');
    const bInput = fBid.querySelector('input');

    cInput.addEventListener('input',()=>{
      if(cInput.value===''){ delete costs[r.size]; } else { costs[r.size]=toNum0(cInput.value); }
      localStorage.setItem(KEY_COSTS, JSON.stringify(costs));
      const rr = calc(map.get(r.size));
      card.querySelector('#W2_'+r.size).textContent = fmt0(rr.w2);
      card.querySelector('#PW2_'+r.size).textContent = fmt0(rr.pW2);
      const pEl = card.querySelector('#PBID_'+r.size);
      pEl.textContent = fmt0(rr.pBid);
      profitEl.textContent = fmt0(rr.pBid);
      const color = isFinite(rr.pBid)? (rr.pBid>=0?'var(--good)':'var(--bad)') : '#4b5563';
      pEl.style.color = color; profitEl.style.color = color;
      buildTable(); // sync desktop view
    });

    bInput.addEventListener('input',()=>{
      if(bInput.value===''){ delete bids[r.size]; } else { bids[r.size]=toNum0(bInput.value); }
      localStorage.setItem(KEY_BIDS, JSON.stringify(bids));
      const rr = calc(map.get(r.size));
      const pEl = card.querySelector('#PBID_'+r.size);
      pEl.textContent = fmt0(rr.pBid);
      profitEl.textContent = fmt0(rr.pBid);
      const color = isFinite(rr.pBid)? (rr.pBid>=0?'var(--good)':'var(--bad)') : '#4b5563';
      pEl.style.color = color; profitEl.style.color = color;
      buildTable(); // sync desktop view
    });

    wrap.appendChild(card);
  });
}

/** ====== SYNC CARD FROM TABLE ====== */
function updateCard(r){
  const id = 'card_'+r.size.replace(/\s+/g,'_');
  const card = document.getElementById(id);
  if(!card) return;
  const w2El = card.querySelector('#W2_'+r.size);
  const pw2El = card.querySelector('#PW2_'+r.size);
  const pEl = card.querySelector('#PBID_'+r.size);
  const profitEl = card.querySelector('.profit');
  if(w2El) w2El.textContent = fmt0(r.w2);
  if(pw2El) pw2El.textContent = fmt0(r.pW2);
  if(pEl){ pEl.textContent = fmt0(r.pBid); pEl.style.color = isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : '#4b5563'; }
  if(profitEl){ profitEl.textContent = fmt0(r.pBid); profitEl.style.color = isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : '#4b5563'; }
}

/** ====== EXPORT CSV (จำนวนเต็ม) ====== */
function exportCSV(){
  const rows = [['Size','ราคาทุน','ราคา W2','กำไร/กก. (W2)','ราคา Bidding','กำไร/กก. (Bidding)']];
  DATA.config.sizes.forEach(cfg=>{
    const r = calc(cfg);
    rows.push([r.size, isFinite(r.cost)?Math.round(r.cost):'', Math.round(r.w2), Math.round(r.pW2), isFinite(r.bid)?Math.round(r.bid):'', isFinite(r.pBid)?Math.round(r.pBid):'']);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='shrimp_bidding_nodecimals.csv'; a.click(); URL.revokeObjectURL(url);
}

/** ====== RESET ====== */
function resetAll(){
  if(confirm('ล้างค่าที่บันทึกทั้งหมด?')){
    localStorage.removeItem(KEY_COSTS); localStorage.removeItem(KEY_BIDS);
    costs={}; bids={}; buildTable(); buildCards();
  }
}

/** ====== SORT CARDS BY PROFIT (BIDDING) DESC ====== */
function sortCards(){
  const rows = DATA.config.sizes.map(cfg=>calc(cfg)).sort((a,b)=>{
    const ax = isFinite(a.pBid)?a.pBid:-1e12; const bx = isFinite(b.pBid)?b.pBid:-1e12; return bx-ax;
  });
  const wrap = document.getElementById('cards');
  const newOrder = [];
  rows.forEach(r=>{ const el = document.getElementById('card_'+r.size.replace(/\s+/g,'_')); if(el) newOrder.push(el); });
  wrap.innerHTML=''; newOrder.forEach(el=>wrap.appendChild(el));
}

/** ====== IMPORT: Excel/CSV ====== 
 * รองรับไฟล์: .xlsx/.xls และ .csv
 * คอลัมน์ที่ใช้: Size, ราคาทุน, SG&A + LG, Margin W2, ราคา Bidding(ถ้ามี)
 */
function parseFile(){
  const file = document.getElementById('fileInput').files[0];
  if(!file){ alert('โปรดเลือกไฟล์ Excel/CSV ก่อน'); return; }

  const ext = (file.name.split('.').pop() || '').toLowerCase();
  const reader = new FileReader();

  if(ext === 'csv'){
    reader.onload = e => parseCSVText(e.target.result);
    reader.readAsText(file, 'utf-8');
  }else{
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array', cellText:false, cellDates:true});
      const firstSheetName = wb.SheetNames[0];
      const ws = wb.Sheets[firstSheetName];
      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''}); // array of arrays
      parseArrayRows(rows);
    };
    reader.readAsArrayBuffer(file);
  }
}

function parseCSVText(text){
  const lines = text.split(/\r?\n/).filter(x=>x.trim().length>0);
  const rows = lines.map(line => line.split(',').map(s=>s.trim()));
  parseArrayRows(rows);
}

function parseArrayRows(rows){
  if(!rows || rows.length<2){ alert('ไฟล์ไม่มีข้อมูลเพียงพอ'); return; }
  const headers = rows[0].map(normalizeHeader);
  const idx = {
    size: headers.findIndex(h => h === 'Size'),
    cost: headers.findIndex(h => h === 'ราคาทุน'),
    sga : headers.findIndex(h => h === 'SG&A + LG' || h === 'SG&A+LG'),
    mw2 : headers.findIndex(h => h === 'Margin W2'),
    bid : headers.findIndex(h => h === 'ราคา Bidding')
  };
  if(idx.size===-1 || idx.sga===-1 || idx.mw2===-1){
    alert('ต้องมีคอลัมน์อย่างน้อย: Size, SG&A + LG, Margin W2 (ราคาทุน/ราคา Bidding ไม่บังคับ)');
    return;
  }

  const sizes = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    const size = String(row[idx.size]||'').trim();
    if(!size || !/^STD/i.test(size)) continue; // รับเฉพาะที่ขึ้นต้น STD ตามเทมเพลต
    const sga  = parseFloat(String(row[idx.sga]||'').replace(/,/g,'')); 
    const mw2  = parseFloat(String(row[idx.mw2]||'').replace(/,/g,'')); 
    const cost = (idx.cost>-1)? parseFloat(String(row[idx.cost]||'').replace(/,/g,'')) : NaN;
    const bid  = (idx.bid>-1)?  parseFloat(String(row[idx.bid]||'').replace(/,/g,''))  : NaN;

    sizes.push({
      size,
      sga_lg: isFinite(sga)? sga : 0,
      margin_w2: isFinite(mw2)? mw2 : 0,
      last_cost: isFinite(cost)? cost : undefined,
      last_bid : isFinite(bid)?  bid  : undefined
    });
  }

  // ใส่ข้อมูลเข้าระบบ
  DATA.config.sizes = sizes;
  // เคลียร์ state (ถ้าอยากเริ่มจากไฟล์ใหม่ทุกครั้ง)
  // localStorage.removeItem(KEY_COSTS); localStorage.removeItem(KEY_BIDS);
  // costs = {}; bids = {};

  buildTable();
  buildCards();
  alert('นำเข้าข้อมูลสำเร็จ: ' + sizes.length + ' ไซซ์');
}

/** ====== INIT ====== */
document.getElementById('exportCSV').addEventListener('click', exportCSV);
document.getElementById('resetAll').addEventListener('click', resetAll);
document.getElementById('sortCards').addEventListener('click', sortCards);
document.getElementById('parseFile').addEventListener('click', parseFile);

// เริ่มด้วยหน้าว่าง (รอ import)
buildTable();
buildCards();
</script>
</body>
</html>
