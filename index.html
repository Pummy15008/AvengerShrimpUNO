<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CP | Shrimp Bidding Helper</title>


  <style>
    :root{
      /* โทนสีสด + เรียบหรู */
      --brand: #00A651;          /* เขียว CP (ปรับได้) */
      --brand-2: #11C5A3;        /* เขียวฟ้าไฮไลต์ */
      --bg: #0b0f1c;             /* พื้นหลังเข้ม */
      --glass: rgba(255,255,255,0.08);
      --text: #eaf2ff;           /* ตัวอักษร */
      --muted: #9fb3c8;          /* รอง */
      --line: rgba(255,255,255,0.12);
      --good:#3adb76;            /* ผลกำไรบวก */
      --bad:#ff5a5f;             /* กำไรติดลบ */
      --accent:#ffd166;          /* เน้น */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"TH Sarabun New",Prompt,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, #12204a 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 10%, #0e2f2b 0%, transparent 60%),
        var(--bg);
    }

    /* Header: gradient + โลโก้ทางการ */
    .header{
      position:relative;
      padding:20px 16px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(135deg, rgba(0,166,81,0.3), rgba(17,197,163,0.15)),
        linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(6px);
    }
    .wrap{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:16px; flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:14px;
    }
    .brand img{
      width:44px; height:44px; object-fit:contain;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.35));
    }
    .title{
      font-size:20px; font-weight:700; letter-spacing:0.3px;
    }
    .toolbar{
      margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;
    }
    button{
      padding:10px 14px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,0.06); color:var(--text); cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s;
    }
    button:hover{ transform: translateY(-1px); background:rgba(255,255,255,0.1); }
    button.primary{
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
      border-color: transparent; color:#061214;
      font-weight:600;
      box-shadow: 0 8px 24px rgba(17,197,163,0.3), inset 0 1px 0 rgba(255,255,255,0.35);
    }

    /* Container */
    .app{ max-width:1200px; margin:20px auto; padding:0 16px; display:grid; gap:16px; }

    /* Import panel: glassmorphism */
    .import{
      border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-radius:16px; padding:16px;
    }
    .import h3{ margin:0 0 6px 0; font-size:16px; }
    .import .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .file{
      display:flex; align-items:center; gap:10px;
      border:1px dashed var(--line); padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,0.04);
    }
    input[type=file]{ color:var(--muted); }
    .hint{ font-size:12px; color:var(--muted); margin-top:8px; }

    /* Desktop table view */
    .card{
      border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: blur(8px);
      border-radius:16px; padding:12px;
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0;
    }
    th,td{
      padding:12px; border-bottom:1px solid var(--line); text-align:right; vertical-align:middle;
    }
    thead th{
      position:sticky; top:0; background:rgba(255,255,255,0.06);
      color:var(--muted); font-weight:600;
    }
    td:first-child, th:first-child{ text-align:left }
    td input{
      width:140px; padding:10px; border-radius:10px; border:1px solid var(--line);
      background:rgba(255,255,255,0.06); color:var(--text);
    }
    .actions{ display:flex; gap:8px; align-items:center; justify-content:flex-end }

    /* Mobile cards */
    .cards{ display:grid; grid-template-columns:1fr; gap:12px }
    .item{
      border:1px solid var(--line); border-radius:16px;
      background: var(--glass); backdrop-filter: blur(10px); padding:14px;
    }
    .item-head{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .size{ font-weight:700 }
    .profit{ font-weight:700 }
    .fields{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px }
    .field{ display:flex; flex-direction:column; gap:6px }
    .label{ font-size:12px; color:var(--muted) }
    .val{ font-size:16px }
    input[type=tel]{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,0.06); color:var(--text); font-size:16px;
    }

    /* Responsive breakpoint */
    @media (min-width: 900px){ .tbl{ display:block } .cards{ display:none } }
    @media (max-width: 899px){ .tbl{ display:none } .cards{ display:grid } }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="wrap">
      <div class="brand">
        <div class="title">CP Shrimp Bidding Helper</div>
      </div>
      <div class="toolbar">
        <button id="resetAll">ล้างค่า</button>
        <button id="exportCSV" class="primary">ส่งออก CSV</button>
        <button id="sortCards">เรียงการ์ดตามกำไร</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- Import Excel/CSV -->
    <div class="import">
      <h3>นำเข้า Excel/CSV (อัปเดตราคาทุนรายวัน)</h3>
      <div class="row">
        <div class="file">
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        </div>
        <button id="parseFile" class="primary">นำเข้าไฟล์</button>
        <button id="clearState">ล้างข้อมูลที่บันทึกไว้</button>
      </div>
      <div class="hint">รองรับคอลัมน์: <b>Size</b>, <b>ราคาทุน</b>, <b>SG&A + LG</b>, <b>Margin W2</b>, <b>ราคา Bidding</b> (ถ้ามี)</div>
    </div>

    <!-- Desktop Table -->
    <div class="card tbl">
      <table id="tbl">
        <thead>
          <tr>
            <th>Size</th>
            <th>ราคาทุน</th>
            <th>ราคา W2</th>
            <th>กำไร/กก. (W2)</th>
            <th>ราคา Bidding</th>
            <th>กำไร/กก. (Bidding)</th>
            <th>การทำงาน</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Mobile Cards -->
    <div class="cards" id="cards"></div>
  </div>

<script>
/* =========================
   DEFAULT DATA (แก้ตามจริงได้)
   ========================= */
const DATA = {config:{sizes:[
  {"size":"STD Jumbo","sga_lg":21.71,"margin_w2":12,"last_cost":286},
  {"size":"STD 4XL","sga_lg":20.96,"margin_w2":12,"last_cost":252},
  {"size":"STD 3XL","sga_lg":20.80,"margin_w2":11,"last_cost":235},
  {"size":"STD 2XL+","sga_lg":20.66,"margin_w2": 9,"last_cost":218},
  {"size":"STD 2XL","sga_lg":20.48,"margin_w2":10,"last_cost":212},
  {"size":"STD XL","sga_lg":19.82,"margin_w2": 8,"last_cost":187},
  {"size":"STD LL","sga_lg":19.57,"margin_w2": 8,"last_cost":177},
  {"size":"STD L","sga_lg":19.23,"margin_w2": 8,"last_cost":164},
  {"size":"STD M","sga_lg":18.79,"margin_w2": 7,"last_cost":151},
  {"size":"STD S","sga_lg":18.38,"margin_w2": 6,"last_cost":136}
]}};

/* =========================
   STATE & UTIL
   ========================= */
const KEY_COSTS='shrimp_costs_v1';
const KEY_BIDS='shrimp_bids_v1';
let costs = JSON.parse(localStorage.getItem(KEY_COSTS) || '{}');
let bids  = JSON.parse(localStorage.getItem(KEY_BIDS)  || '{}');

const toNum0 = v => {
  const s = String(v ?? '').replace(/[^0-9-]/g, '');
  if (!s) return NaN;
  const n = parseInt(s, 10);
  return Number.isFinite(n) ? n : NaN;
};
const fmt0 = n => (n===null||n===undefined||isNaN(n))?'-':String(Math.round(Number(n)));

/* IME commit + mobile press helpers */
function runAfterIMECommit(fn){ setTimeout(fn,0); } // or requestAnimationFrame(fn)
function bindCalcPress(el, handler){
  const wrapped = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); runAfterIMECommit(handler); };
  el.addEventListener('click', wrapped, {passive:false});
  el.addEventListener('touchend', wrapped, {passive:false});
}
function bindEnterAsCalc(inputEl, pressFn){
  inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); runAfterIMECommit(pressFn); } });
}

const bySize = () => new Map(DATA.config.sizes.map(s=>[s.size,s]));

/* =========================
   CORE CALC
   ========================= */
function calc(cfg){
  const size  = cfg.size;
  const cost  = Number.isFinite(costs[size]) ? costs[size]
                : Number.isFinite(cfg.last_cost) ? cfg.last_cost
                : NaN;
  const floor = (Number.isFinite(cost) ? cost : NaN) + cfg.sga_lg;
  const w2    = Number.isFinite(floor) ? floor + cfg.margin_w2 : NaN;
  const pW2   = Number.isFinite(w2)&&Number.isFinite(floor) ? (w2 - floor) : NaN;

  const bid   = Number.isFinite(bids[size]) ? bids[size]
                : Number.isFinite(cfg.last_bid) ? cfg.last_bid
                : NaN;
  const pBid  = (Number.isFinite(bid) && Number.isFinite(floor)) ? (bid - floor) : NaN;

  return {size,cost,w2,pW2,bid,pBid};
}

/* =========================
   CALCULATE (per row / card)
   ========================= */
function calculateRow(cfg, refs){
  const {costInput,bidInput,cW2,cPW2,cPBID} = refs;
  const costVal = costInput.value.trim();
  const bidVal  = bidInput.value.trim();

  if(costVal===''){ delete costs[cfg.size]; } else { costs[cfg.size]=toNum0(costVal); }
  if(bidVal===''){  delete bids[cfg.size];  } else { bids[cfg.size] = toNum0(bidVal); }
  localStorage.setItem(KEY_COSTS, JSON.stringify(costs));
  localStorage.setItem(KEY_BIDS,  JSON.stringify(bids));

  const r = calc(cfg);
  cW2.textContent  = fmt0(r.w2);
  cPW2.textContent = fmt0(r.pW2);
  cPBID.textContent= fmt0(r.pBid);
  cPBID.style.color = Number.isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : 'inherit';

  updateCard(r);
}

function calculateCard(cfg, refs){
  const {costInput,bidInput,w2El,pw2El,pBidEl,profitEl} = refs;
  const costVal = costInput.value.trim();
  const bidVal  = bidInput.value.trim();

  if(costVal===''){ delete costs[cfg.size]; } else { costs[cfg.size]=toNum0(costVal); }
  if(bidVal===''){  delete bids[cfg.size];  } else { bids[cfg.size] = toNum0(bidVal); }
  localStorage.setItem(KEY_COSTS, JSON.stringify(costs));
  localStorage.setItem(KEY_BIDS,  JSON.stringify(bids));

  const r = calc(cfg);
  w2El.textContent   = fmt0(r.w2);
  pw2El.textContent  = fmt0(r.pW2);
  pBidEl.textContent = fmt0(r.pBid);
  profitEl.textContent = fmt0(r.pBid);
  const color = Number.isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : '#9fb3c8';
  pBidEl.style.color = color; profitEl.style.color = color;

  updateCard(r);
}

/* =========================
   BUILD VIEWS
   ========================= */
function buildTable(){
  const tbody = document.querySelector('#tbl tbody'); if(!tbody) return;
  tbody.innerHTML='';
  DATA.config.sizes.forEach(cfg=>{
    const r = calc(cfg);
    const tr = document.createElement('tr');

    const c0 = document.createElement('td'); c0.textContent = r.size; tr.appendChild(c0);

    const c1 = document.createElement('td');
    c1.innerHTML = `<input type="tel" inputmode="numeric" pattern="[0-9]*" value="${Number.isFinite(r.cost)?Math.round(r.cost):''}" aria-label="ราคาทุน">`;
    tr.appendChild(c1);

    const c2 = document.createElement('td'); c2.textContent = fmt0(r.w2);  tr.appendChild(c2);
    const c3 = document.createElement('td'); c3.textContent = fmt0(r.pW2); tr.appendChild(c3);

    const c4 = document.createElement('td');
    c4.innerHTML = `<input type="tel" inputmode="numeric" pattern="[0-9]*" value="${Number.isFinite(r.bid)?Math.round(r.bid):''}" aria-label="ราคา Bidding">`;
    tr.appendChild(c4);

    const c5 = document.createElement('td'); c5.textContent = fmt0(r.pBid);
    c5.style.color = Number.isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : 'inherit';
    tr.appendChild(c5);

    const c6 = document.createElement('td'); c6.className='actions';
    c6.innerHTML = `<button class="primary" type="button">คำนวณ</button>`;
    tr.appendChild(c6);

    const costInput = c1.querySelector('input');
    const bidInput  = c4.querySelector('input');
    const calcBtn   = c6.querySelector('button');

    ['input','change','keyup','blur'].forEach(ev=>{
      costInput.addEventListener(ev, ()=>{ if(costInput.value===''){ delete costs[cfg.size]; } else { costs[cfg.size]=toNum0(costInput.value); } localStorage.setItem(KEY_COSTS, JSON.stringify(costs)); });
      bidInput.addEventListener(ev,  ()=>{ if(bidInput.value===''){ delete bids[cfg.size]; } else { bids[cfg.size]=toNum0(bidInput.value); }  localStorage.setItem(KEY_BIDS,  JSON.stringify(bids));  });
    });

    bindCalcPress(calcBtn, ()=>{ calculateRow(cfg, {costInput, bidInput, cW2:c2, cPW2:c3, cPBID:c5}); });
    bindEnterAsCalc(costInput, ()=>{ calculateRow(cfg, {costInput, bidInput, cW2:c2, cPW2:c3, cPBID:c5}); });
    bindEnterAsCalc(bidInput,  ()=>{ calculateRow(cfg, {costInput, bidInput, cW2:c2, cPW2:c3, cPBID:c5}); });

    tbody.appendChild(tr);
  });
}

function buildCards(){
  const wrap = document.getElementById('cards'); if(!wrap) return;
  wrap.innerHTML='';
  DATA.config.sizes.forEach(cfg=>{
    const r = calc(cfg);
    const card = document.createElement('div'); card.className='item'; card.id='card_'+r.size.replace(/\s+/g,'_');

    const head = document.createElement('div'); head.className='item-head';
    const sizeEl = document.createElement('div'); sizeEl.className='size'; sizeEl.textContent=r.size; head.appendChild(sizeEl);
    const profitEl = document.createElement('div'); profitEl.className='profit'; profitEl.textContent = fmt0(r.pBid);
    profitEl.style.color = Number.isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : '#9fb3c8';
    head.appendChild(profitEl);
    card.appendChild(head);

    const fields = document.createElement('div'); fields.className='fields';

    const fCost = document.createElement('div'); fCost.className='field';
    fCost.innerHTML = `<div class='label'>ราคาทุน</div><input type='tel' inputmode='numeric' pattern='[0-9]*' value='${Number.isFinite(r.cost)?Math.round(r.cost):''}'>`;
    fields.appendChild(fCost);

    const fW2 = document.createElement('div'); fW2.className='field';
    fW2.innerHTML = `<div class='label'>ราคา W2</div><div class='val' id='W2_${r.size}'>${fmt0(r.w2)}</div>`;
    fields.appendChild(fW2);

    const fPW2 = document.createElement('div'); fPW2.className='field';
    fPW2.innerHTML = `<div class='label'>กำไร/กก. (W2)</div><div class='val' id='PW2_${r.size}'>${fmt0(r.pW2)}</div>`;
    fields.appendChild(fPW2);

    const fBid = document.createElement('div'); fBid.className='field';
    fBid.innerHTML = `<div class='label'>ราคา Bidding</div><input type='tel' inputmode='numeric' pattern='[0-9]*' value='${Number.isFinite(r.bid)?Math.round(r.bid):''}'>`;
    fields.appendChild(fBid);

    const fPBid = document.createElement('div'); fPBid.className='field';
    fPBid.innerHTML = `<div class='label'>กำไร/กก. (Bidding)</div><div class='val' id='PBID_${r.size}'>${fmt0(r.pBid)}</div>`;
    fields.appendChild(fPBid);

    const fActions = document.createElement('div'); fActions.className='field actions';
    fActions.innerHTML = `<button class="primary" type="button">คำนวณ</button>`;
    fields.appendChild(fActions);

    card.appendChild(fields);

    const costInput = fCost.querySelector('input');
    const bidInput  = fBid.querySelector('input');
    const calcBtn   = fActions.querySelector('button');
    const w2El      = card.querySelector('#W2_'+r.size);
    const pw2El     = card.querySelector('#PW2_'+r.size);
    const pBidEl    = card.querySelector('#PBID_'+r.size);

    ['input','change','keyup','blur'].forEach(ev=>{
      costInput.addEventListener(ev, ()=>{ if(costInput.value===''){ delete costs[cfg.size]; } else { costs[cfg.size]=toNum0(costInput.value); } localStorage.setItem(KEY_COSTS, JSON.stringify(costs)); });
      bidInput.addEventListener(ev,  ()=>{ if(bidInput.value===''){ delete bids[cfg.size]; } else { bids[cfg.size]=toNum0(bidInput.value); }  localStorage.setItem(KEY_BIDS,  JSON.stringify(bids));  });
    });

    bindCalcPress(calcBtn, ()=>{ calculateCard(cfg, {costInput, bidInput, w2El, pw2El, pBidEl, profitEl}); });
    bindEnterAsCalc(costInput, ()=>{ calculateCard(cfg, {costInput, bidInput, w2El, pw2El, pBidEl, profitEl}); });
    bindEnterAsCalc(bidInput,  ()=>{ calculateCard(cfg, {costInput, bidInput, w2El, pw2El, pBidEl, profitEl}); });

    wrap.appendChild(card);
  });
}

/* =========================
   SYNC
   ========================= */
function updateCard(r){
  const id = 'card_'+r.size.replace(/\s+/g,'_'); const card = document.getElementById(id); if(!card) return;
  const w2El = card.querySelector('#W2_'+r.size);
  const pw2El= card.querySelector('#PW2_'+r.size);
  const pEl  = card.querySelector('#PBID_'+r.size);
  const profitEl = card.querySelector('.profit');
  if(w2El) w2El.textContent = fmt0(r.w2);
  if(pw2El) pw2El.textContent= fmt0(r.pW2);
  if(pEl){ pEl.textContent = fmt0(r.pBid); pEl.style.color = Number.isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : '#9fb3c8'; }
  if(profitEl){ profitEl.textContent = fmt0(r.pBid); profitEl.style.color = Number.isFinite(r.pBid)? (r.pBid>=0?'var(--good)':'var(--bad)') : '#9fb3c8'; }
}

/* =========================
   EXPORT / RESET / SORT
   ========================= */
function exportCSV(){
  const rows = [['Size','ราคาทุน','ราคา W2','กำไร/กก. (W2)','ราคา Bidding','กำไร/กก. (Bidding)']];
  DATA.config.sizes.forEach(cfg=>{
    const r = calc(cfg);
    rows.push([r.size, Number.isFinite(r.cost)?Math.round(r.cost):'', Math.round(r.w2||0), Math.round(r.pW2||0), Number.isFinite(r.bid)?Math.round(r.bid):'', Number.isFinite(r.pBid)?Math.round(r.pBid):'']);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='shrimp_bidding.csv'; a.click(); URL.revokeObjectURL(url);
}
function resetAll(){
  if(confirm('ล้างค่าที่บันทึกทั้งหมด?')){
    localStorage.removeItem(KEY_COSTS); localStorage.removeItem(KEY_BIDS);
    costs={}; bids={}; buildTable(); buildCards();
  }
}
function sortCards(){
  const rows = DATA.config.sizes.map(cfg=>calc(cfg)).sort((a,b)=>{
    const ax = Number.isFinite(a.pBid)?a.pBid:-1e12; const bx = Number.isFinite(b.pBid)?b.pBid:-1e12; return bx-ax;
  });
  const wrap = document.getElementById('cards');
  const newOrder = [];
  rows.forEach(r=>{ const el = document.getElementById('card_'+r.size.replace(/\s+/g,'_')); if(el) newOrder.push(el); });
  wrap.innerHTML=''; newOrder.forEach(el=>wrap.appendChild(el));
}

/* =========================
   IMPORT Excel/CSV
   ========================= */
function parseFile(){
  const file = document.getElementById('fileInput').files[0];
  if(!file){ alert('โปรดเลือกไฟล์ .xlsx/.xls/.csv ก่อน'); return; }
  const ext = (file.name.split('.').pop() || '').toLowerCase();
  const reader = new FileReader();

  if(ext === 'csv'){
    reader.onload = e => parseCSVText(e.target.result);
    reader.readAsText(file, 'utf-8');
  }else{
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array', cellText:false, cellDates:true});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});
      parseArrayRows(rows);
    };
    reader.readAsArrayBuffer(file);
  }
}

function parseCSVText(text){
  const lines = text.split(/\r?\n/).filter(x=>x.trim().length>0);
  const rows = lines.map(line => line.split(',').map(s=>s.trim()));
  parseArrayRows(rows);
}

function normalizeHeader(h){ return (h||'').replace(/\r?\n/g,' ').trim(); }

function parseArrayRows(rows){
  if(!rows || rows.length<2){ alert('ไฟล์ไม่มีข้อมูลเพียงพอ'); return; }
  const headers = rows[0].map(normalizeHeader);
  const idx = {
    size: headers.findIndex(h => h==='Size'),
    cost: headers.findIndex(h => h==='ราคาทุน'),
    sga : headers.findIndex(h => h==='SG&A + LG' || h==='SG&A+LG'),
    mw2 : headers.findIndex(h => h==='Margin W2'),
    bid : headers.findIndex(h => h==='ราคา Bidding')
  };
  if(idx.size===-1){ alert('ไม่พบคอลัมน์ Size'); return; }

  // อัปเดตค่าคงที่ต่อไซซ์จากไฟล์
  const sizes = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    const size = String(row[idx.size]||'').trim();
    if(!size || !/^STD/i.test(size)) continue;
    const sga  = (idx.sga>-1)? parseFloat(String(row[idx.sga]||'').replace(/,/g,'')) : undefined;
    const mw2  = (idx.mw2>-1)? parseFloat(String(row[idx.mw2]||'').replace(/,/g,'')) : undefined;
    const cost = (idx.cost>-1)? parseFloat(String(row[idx.cost]||'').replace(/,/g,'')) : undefined;
    const bid  = (idx.bid>-1)?  parseFloat(String(row[idx.bid]||'').replace(/,/g,''))  : undefined;

    // คงค่าเดิมถ้าไฟล์ไม่ให้
    const prev = (bySize().get(size)) || {};
    sizes.push({
      size,
      sga_lg: (sga!=null && Number.isFinite(sga))? sga : prev.sga_lg ?? 0,
      margin_w2: (mw2!=null && Number.isFinite(mw2))? mw2 : prev.margin_w2 ?? 0,
      last_cost: (cost!=null && Number.isFinite(cost))? cost : prev.last_cost,
      last_bid : (bid!=null && Number.isFinite(bid))?  bid  : prev.last_bid
    });
  }

  DATA.config.sizes = sizes;
  buildTable(); buildCards();
  alert('นำเข้าข้อมูลสำเร็จ: ' + sizes.length + ' ไซซ์');
}

/* =========================
   INIT
   ========================= */
document.getElementById('exportCSV').addEventListener('click', exportCSV);
document.getElementById('resetAll').addEventListener('click', resetAll);
document.getElementById('sortCards').addEventListener('click', sortCards);
document.getElementById('parseFile').addEventListener('click', parseFile);
document.getElementById('clearState').addEventListener('click', ()=>{
  if(confirm('ล้างข้อมูลที่บันทึกในเครื่องทั้งหมด (ราคาทุน/ราคา Bidding)?')){
    localStorage.removeItem(KEY_COSTS); localStorage.removeItem(KEY_BIDS);
    costs={}; bids={}; buildTable(); buildCards();
  }
});

buildTable();
buildCards();
</script>
</body>
</html>
